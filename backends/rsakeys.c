#include "backend_common.h"

char n1[] = "n = 00b67b1cee2ff9f99f94478a23200816e04498458f4b32d8ca345b68865b9c86d17b274bcb4f41ba0957afdbaa2760c9d38aa0bf4a61b00f422884fdeb4d3819461dcfa484ff2369281cb7e121cfe5b12a0007bf997546c56370d511c675c93f6b54e70a09692de5d9c11947f6b1401f3d0a83457acdee25ae02e234d5b7981e25";

char e1[] = "e = 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001";

char d1[] = "d = 00a550ab48ed95dd1b40cdfecb0b7dc89bac08f71b75d8bea591012e9469f24801073cf6615d9001e5ecd6987e71e63171bfa919235d948e7e350f26aa40ee8d957c285c2448cd7c26b57ddc72920bc21722b25bb17faf0a24d9c9a97d665c7f48f235ed72c945113a2665411e5f2acd06ef213e27f61219426f893532ebeaaa81";

char p1[] = "p = 00dece6876610ee201896273a054e1665106ffc35c9a9e81426412bbb2943b41127ca7ee28d5f295ab83e0ac95b1ffe2c7a2a3169fa15fff59e085b783089c4d3d";

char q1[] = "q = 00d1aabd1907dde6e7fee27bf097e9bb2a7f30cc912da5ffb5c160ca0d42405fc52af808e290675e76f47532cb26fbbf2ae5b174717fe28233bd96670595737309";

char dp1[] = "dp = 0e1d9590aa657efc09f02ad3258d8225f0039424f1c6c8f9a3cd6c06cc4d54ba0f1bb482f1cb04a0712272cca9124513d0c1f454f8ac54492568535001e3a521";

char dq1[] = "dq = 00b4bc87d181f4894dc76c1906e70d36a88587dd6ff077be1c419c5bd05e21fbec8d03cf34eee20c8e62607cee9ea638be93ce0ae0a42aefae066a1658bbe20f71";

char qinv1[] = "qinv = 138b87bdf1bba3a7e975f52a7dc05ba728d7bc497e16b9dce2a7ab13b21bbaf067776d4b6f4ae6b3e7c176722c36ebdff27ada9e5a59b71550b1eeeb8bfc3f60";

char n2[] = "n = 00cf6dc3ce2b18d8740a4de64a49fb2643bef107c5db64b789e3cfccc92b7baee480534e5e07522752ab8f6e098fff9f893459d97ca1913630077344daf7296da1320b0cdd2711b409a99c8f7f95b10c1603680e552ebb3d0b59f63788b6b713b01eb1e0ef04322cd9254bd577103cc34a537296c92c9f60ea4cf01d4b0bf9c4b4908fbd3ed41087ba7b0c3f6d847aa01eb2111b759a9bf609be24d0ee65643f73187752f88a83f8ab7cffe3918c5a6a1d96fd27d764fae92ad7369e3a81afcfc1111d4557fedf4e9049704539ab9c513a08b93b46e571eb1cd0629dd4b74bb0fcaf36ddab80c345b0092ecc3c416889332327a72f49d17800a535a9ced8de66a9";

char e2[] = "e = 00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001";

char d2[] = "d = 00c7e21d2a61cb4a61dfc01b67810cfc5d91f510297076088b5eb4d2c1141ed674a8d81e0f6bfc959a0b6a667dde7e548cd19eb77e6aeed489c9d42108e3ddcf1fe36a549613dcf261d148e5daeb33b5d2ccab8c0c37c1045d18eeb3ab116f3010aa337ceeb65b676e448b64039ce900c371d05d4f34a9cca95b4492e5cb7f7f35485c721e2462a56c467a1131f3bfcf841b7955d0a2f2df99e569b38c90bda580ad883adb94e91e88fe75aeef62d1d4910e4837065189cb658e447d39adddc3716e6a6377954e773fc559311606bb7fff53eb599719af8e13b2e9cb679e43c15b999825566d662fdb3530aee807a84ff19cbed6ae10c6f25ece0397481fa0be01";

char p2[] = "p = 00ea9635c04ef5a84a4c6ee7887be339bfdb8323ab361cd10c00ac5567b45ea7a95641b495bf5ea708fc8c40215d53809abb19bd9f11a8ada0a0c6a78da7771bf861dadd944d6496f2dd06bbc64b094d6647bb8acd5cd74f149d06c4e5a56bbb19bc5a136a2c632d622f951a226b06003092f508db26dfd04d6ab86694ab5659e9";

char q2[] = "q = 00e25cee4df37ea87dc850bd247d55572f9296dd50fb93fd7c39dccc5ce6b9451593f20f1c4a15395e828c7b4c78d8db6ac6de7c0475f8a9d79f59811e66163562e7fca373507dd934e0a37a5dbe60aa6aa39a74393abf37039ca781e78912224f1aafc010e8eb36061ab3d01e8db8cd6f965e9e7cb52595f449b79e22b0feeec1";

char dp2[] = "dp = 528810571d307e49cd84433f185f040544e4695b2609935e86aa1ace067e3abc6fd564043f34bccd839490476cbf2102cf0aaa54d9709fcd606323b5c992352bf8b978b561591f66486ec3076b84d54f43b36e8cfbb9e05f9f332f789fef3bff3cedefe0adc722c3657c2e9aa74e902886bb60a7419102870a21e02d33ee8869";

char dq2[] = "dq = 01e0213d561a238d3f3ea4028c634ba0a2474bb8230d7bd92ea58cafec5d769c1228bc4550bbd248dd2e0acb7c68d7908feb41fdcb786ef7d1632d75b204d71665b3ab2b066cb48302a5781b14bbba4dbde346b93eaa5ceb53bdf38e968d26e99edffbe867f5a2f1f400af65c168d992e61d0c951def1cc9f45e681a037b6941";

char qinv2[] = "qinv = 248bec97cda4268589666ff56aeef012d915dac5ee1bfb18d1979246675ec7769cacf318b0af387e5a322034b407a76663cfb5916fbfe44a621f19568b53d30e3b75aebe5fac3fd38c74d273465fe06a7aa63ce610b4401d5cdaea503aa959b8930a20fd4bd6676dd0fec539d6b926840ca478bb5f62687da9f501f90cb44b35";

char n3[] = "n = 00db3b5c32a21331e2b490f682589ae4e3290d2facdd07a69277b92f3a504d5927db497b91b76e843d16e99de6e24c7c77d0ed87635c1274fbace82e535b2df7c13a51bb23831a64135bd941435fb55facaf13187a516ceb2f1e1e8211881c015dc619d83af678e8e2f343054e9d8f805890f196f154c3d7d3482e5e12fe5b04b586ee344b3f7b138e761419ffeafe33eda7f72c46777d8b7558c3caf4e0942f217216e7d8ce2aecb204d1a41dee496560d512fe595755001d81dc23a910549926fd55b7b9dce4fc768d1e2ef11e87abe24f25e50d3a9dc49494a84d041a28ed3ba86d5ffd4cf11a9c07f1205537d7602bd54112b90d4a49c6ba4461c0992e10637eb4aa74fe8d03f45409b388b053c28bad5a923f947c4bfdfeb51d652f80c359561540da17bb11ae5ec0edd43d20ac7a042724b7e8c28f69b2675e4365c45a6fdc93f9642a4e2bc97f36e44c3500c6af4321d70a69e70f36f13dc4cba926f32b18210dfdc103a6959f8b422a30647d549e3086a8970e548b96526fde1db5fb87";

char e3[] = "e = 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001";

char d3[] = "d = 6fb2c3dbec661941a7bc404cd336402e592925c44e6d6a7a2fd3c373539cc5332070452c4e2859ea02358f4526c1cf9d006f354ef38757e12f0cb125b94c277264f36584c77477cec13a651d1db37c86b040eb74ceedceba17ff7547d7706565d0dc34267e93c61c73d30eee2a2b063a99c6eda0120f2274bccf1b1154552d860bb46c2276ba8f91432a24c1168ae40c4f4b095cf1de9e6270927962e0d5bf59ac166d94321efeb008f2834ad8b0be9d6292a5d3014306a7021616793a1fd05372cfa957e90e2f8973fda5c540c2553d8c8749ee148231ec5c59d6c9d0ef167456b90d3b86b2655ff150374c7b75916d0ee83291b2d7a98bfe2dca8e04713b5070d81e02f29fe71673afeb3e6324f0199b875c436b84d04b742ebdf6642aac6b72108dfd95b02a1ab5fe71cbf01fcbb5f83b53c1cb48237748c4a8aa1e326beeb448fe47f5716b8ebb0777578bd6c4021266239367becdd50ed629b6572ee3e813a5bbcbe3eff20edcf85d08b69cb073f616400ebeea1541d4e2a1a5cea9df21";
 
char p3[] = "p = 00eec009bbd011818137ce0ba6d6c7f658455e9463f08e15eb5d72d910fdb9e130e004de70b7beb968c8bb1d9b5835088fa0102630eecef87bf5204c69abf0476d9aa93fe305ebdb154e4f9d8f6794da021a59e2c8237ec1966f1ed38604a1ddcb0f0ea41477ae95ba1d17401d5bab494d966c97d8794939f9f94138095f2fad6e84bcbafd35453aa86c502a3c99d807c4e0aef3136280a7055c6feb53af9d90f9f60c815224c28ba58dc569eb8fe079c412d01b31032de9fd1e7e7141a02e6c51";

char q3[] = "q = 00eb124f16d17a268ed912a31a63c818b78eb0bba7ca7a1bcce6f79ab33213e4ec5446f4edd9ea12fb46435e7bdfe10ca1e2e300d582f97a77101ba2fbe64b1a9f1638176a9125231676573b4137da79df1d672143ffcdf85014e8fd10bb5f72b310ff92eb4d4faf4aa3096e17c6057643f93ee6b7e5d563e28dc75abeda5cd0a1b0f6152bbbd6924a5ebb40e93d87d46dff0e3bedcda904d37f63a352821a3b03e13a92b6f19feb77808a4436f68694efb131ed76dd66e5ab6c9bada5ae2d6c57";

char dp3[] = "dp = 61b28fc91d11accef5c9091792986d041e0edfe62d8fd704634f15e8500b7a4d07beb64fa5c11419feda22f96894fb15dac800f8d1203caa6cda74aa614387d7200cd629ce487f742e8181d626ead0733fd93c65edb077035a2161295c47e87ca982b23df5e3a93d699e140c6f709e2473c3a8375b1a4df12ec0337012556e40e56c5d9033f64a54954e109a8fd1c90c156d41e6d2ce168aa912db57796b9ee1ca7fbf839fab447dd08fd21224e414afd98af33591397ea0a793d240aa8d94a1";

char dq3[] = "dq = 0095aed3e3a0c19a39cda99b681b6f77a5b25b813287b0977133052961bf9a8163a70a83bdcccbcb086ba64c4caeb33bfafd6134cfc015a1d09cd62c43205264823680c3105d99fb2cbb7032500603bd24c03142326d79b70b2f3568a735d8c24d999e53ec370f6d7c2632c402a95a2303877b71285a5635c3362a61f33352749af0f6d16646b68bf2853dd14873a0c138c57747dbd5e0312d876967bf0b0f2ed2faa0f4793f84684870f61a17b184e2e379be640a1353091dce0b9757ef800703";

char qinv3[] = "qinv = 26b1983617a16e69482b5851be3a78120b4df636e37967ab50e94311ffa15b7005619689833aeccbaf12814cfce5c14c51dc5d06be97be38f7f647d73bfebf03b22ead82ec37f914b128f9ff3b8fd60ad6bf5ca01339089f1b79cfc9b583e8b1206227be36a3ecdeb7709b487223b0b1d0064965f046e4e1c7a1a7431326e8d89d41036cf66f3a91d9ef4dcaa32e480460bfb3b85ea8961b5660d6899a13d4ad5c5a5f0c177c782ca5138b6f5021138b719da3e9f2839e23400409291a1f4f72";

char n4[] = "n = 00b0f8806586b722f4140704f000f51fc90328ad8ec8e40deb6914f9cc4afe296314b9cc6bbc165bf427944ca0d6686bfdab52fed2533a3a86cd6a584cd87aa3aa0fae92ab308ac6967bba04d4c2eab4cafe7e849a692eef1134d10da21b5b8fb29454bbfad6ffb098ecf16cd161521fcc92667f950cd4e34b5424b0c8a20500a993886482a935a8c606bdc9108891f9e8609abe17c39ef46b92f5b4e7a324cda942b8fd0e734b2a2bfc2d7548f88f1badd8aba95a8cde6312e889b4385eaafef139aed6df764fb6e34a5bd3e14de82ee59fd256511b5f66154e0dfaedb574dd4051dc725662d921d273c0346d6734b4cbfcc38344ecba5c4466b5b7ee503fa6795cb57d93c16c0534efb9cdf6b18d26ec3912315d1268d29ce274c4e5bf466eddb692eed39f7b4be48bdef23fd40e5c11409a50ac81ab9f60f5ada7a2b9f957e8c0f3241fa1899531193266d58af5e46665f8a15afbb0c6ef47874a60dd0ca5fed563c4392c2ed8b17b53a628a19f1bf1da28d97edf15c2646181550a793de69f1e59c77416b0754802b576086410536cbafa8e931b55b240934d301b1f11c08a7e73e14546955f2ade09e5111fa0b3a22908ac96283b8aa11eb2228c5ec1e5265b9f62a1b201a2baa075fad3a423d42682eb390a0cc80d8ac3da9262d15ae13f4dd7f270329f4ec9241834fc5ec60500a83d8602f810a44b6bb92c8449ec2245";

char e4[] = "e = 0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010001";

char d4[] = "d = 2a651dbd34aca2befe1d405d8e9d2a64295191626755dacfce78abeef8f83249fe291483aaa76097f8f359f81de51e19c2f53afe7fd9af33a3fa19f52ed712662723971753a5ab3559a69289b5b82c5f84e0223c2b7e86df045c207bf939d20ee1e1fab678d30027627be3a9b53acb4b62b713514da5a25de56674c35bacff1fa0ac4807d52979a916ec584291b506bd5887398acfde408794c92ff15defef24e14b17b462825b33f6519d8b41a066ed1abee4ef4057f63c0d610fbf814e4d8cd458c238fe4ad27158daeec346ba9ca17dcc11c994592247704f8111792ae9e602b660ddb9087345cb5cfc32494b2314cb14bb59c3ac51764174beff64521b3b0976a1aabb1fdae4b98dd77d6bad3f87ace55f6d8666f11a48f0bae89c49b7311b07ad28410a7775911326827f4a9f62969f8054a4a533d06d843c3f9ed8659863e277768f896068cf046335bdb8c05be82eb6b05a066c5302981c517f6b8546667a08c967ca3040ca5c4b85684b7b9d29505b4eaccb9ba4b9e24729db089220ba9df811956cc62257b8d6765e64782e62468cd841bc262a84a47b62232e7812b57b9b891bae7a454b3cf415aca4e8e3e064801a3195afc5d9554d4e68470da75edd5d70e9c20a327a1162925e3706674d688765aadb41356e36bab6647c7984be351643dff9d916c14962495f140a905c60afee09eace87711124cef3296181";

char p4[] = "p = 00e3e0d464b3a88f16d033fbfccac54cbcb7c6e86c7155bfe1fa6e12483d94aeb998f4e15924fd79736ec8ad908338028d274c87565ced66bfa05153fa7c870be579f5da3f2b11f5b41ced6a11c6fe732f867620460f9b847633aac5b4fae916bb10e50c3f0268691081304a9029d7fb48c79859b5bfaef6768f6b12af0dc62e2cfe35df6201b7ee49d5294943e4fe3c03eb7a046abcaf44ab7de665a3989c7703184e90133a47818b1f5d116efbe2565296385948ea4e9e25e8a22034a3901f01eea973d9ebcabb3676c764eb74f71058d17741911ef52b86343fe8341e2301f5d636406050ecd522577577753da591c525f0c4e1ab5ba0b748bb44ff822c405d";

char q4[] = "q = 00c6cf6459f521df0d49cf814eb4734565a2158933d81d73a1a1bb5e21346eb5b981549bcbc68ff223c021f331cc27d5ae43ecf28e16c1582be9146c1e3e3a96e03a7c39190700978f84a1914ece3b2cc8e5fd45adcb08f59df23880145feff4fb2db14747f6f91d12bf9d8e0ce4d0e99a0e5d8cc7e1ba8922a0568d4bcbb277a8826321047dbee09fa3beafe0eb6cc64a711bfaf2957ef8449e30b87ce59bc7e96758e453a6902a6526687bee4ee109bf583cc876a185d9719af9ebb70fb3145ecaac8d4cd794b2171b1304b9897c64582a1e4028fe817bcd644b24966ae78cd349af51c6fdb70600607e6b0a880687a4036c94043ecd023ccf4d1ea169e36b09";

char dp4[] = "dp = 00842848057f0c2ab0185f8dacb60c66ccabe877b32ca78679103bf5ee5f88732cc04084d0a65b3aac6f7b82ed64ac7f0e4dd45c4901ebccc325bf04ed287b49b2f460590a797818ff34279c7462ebfef17911d8f5c8e77092fcb3f5a5583f0627c74c8f259bc7e1e6e8859138ba8bbff81d8985bd9a45663aac4274bb8149864e21c02ca53249f1b07027598e3ea8133652c298fd2e2097babd717950bf993e8c54f47b2a2b8a7cdeaa79d73a7e6a6d95c7f9360ecb947cb38f8f370e502dad4df993dcd46da34d9ff093033c6ac13e81c4395d954456fbbf015e6ed48b05d285388e8e174dd78c643644b1db14bd8924c534357a8b5ec07e8b77d0343ed25b21";

char dq4[] = "dq = 00c47c861e8e31caa3f475fbc3507eb87088efa5e932477157a6636ad5805f8684ef78327e042191db9971344cdc0be698d39323ea203d382a35b2b46473762e55301843ca236c875e1564251b70a175529c5363812f300ca7ec93c0a9e2636288b89103f4f0f725afb8e73b542cf4f85b04a59a9495d868de6afeffa8908a32cebd06c1c4118f0bab5b0704065446edf6f6b103a4aaf190e7283cd8a8bfb8e5ac1d32f27e6619077d6ea7470cb0b2a29294df85f411111b65b71817c995df945b570d909d08577267799fa344c7c7c3d88acfd8f36b0d87d0e7b588548d1589cdec7e346169b1706200fc1048994572db3b731d1ad102869a98fb0c31d5582919";

char qinv4[] = "qinv = 0087879b3d456cfb6320a1b9f569ce6b96ae69f0e1f28b392a18c8ca58c1302f15ca9389383783856e095badac4323a319fd1dc8a28f7555c8f70e37a852d1b69403c9e1bfde4fd93ca0c42d7d6a5702b61705d70d43cef02b95b331df9603365e5dedbd71c3f2642c3d3b64fa3b83946d07da52446051e54bcf1dec5050a6ea394018171dd8d2dfc94e52f4929549d63d1e03a285d75ca4846c802263146c412023bb54c7055fb7b44ebd797debb647cc70eb0e981209447e22346a11172fdde2ac51e9971cb1e9a23eb2ce259db667ed1193a86249cb3541d2dd9bb5b4cbcfd3d509c4fefe4901c70ae89de309a93d737f208fbb56da272839bcf659fe77b2";

extern unsigned char * write_field(unsigned char *ptr, unsigned char *src, unsigned short int len);

int rsa_private_key_ber_encode(struct rsa_siggen_data *data, struct buffer *d, struct buffer *p,
			struct buffer *q, struct buffer *dp, struct buffer *dq,
			struct buffer *qinv, struct buffer *pk)
{
	/*
	BER encoding for private key*
	1. Calculate total length of Private key

	Metadata for complete key = 0x30 and sum of length of all fields

	2. BER encoding the length of any field

	actual length of a field = 0x02 and len

	if length <= 127 - 1 byte (actual length)
	if length > 127 and length <= 255 - 2 bytes (Byte1 = 0x81, Byte2 = actual length)
	if length > 255 - 3 bytes (Byte1 = 0x82, Byte2 and Byte3 = actual length)
	*/

	unsigned short int nlen, dlen, plen, qlen, dplen, dqlen, qinvlen;
	unsigned short int elen, total=0, extra;
	unsigned char *ptr;
	unsigned char *tmp;
	unsigned char blank[3] = {0x02, 0x01, 0x00};

	if(!data)
	{
		logger(LOGGER_ERR, "rsa: rsa_siggen_data is empty, returning -EINVAL...\n");
		return -EINVAL;
	}

	nlen = data->n.len;
	elen = data->e.len;
	dlen = d->len;
	plen = p->len;
	qlen = q->len;
	dplen = dp->len;
	dqlen = dq->len;
	qinvlen = qinv->len;

	/*
	Before the Chinese Remainder Theorem was introduced in kernel code we did not have to encode a total of 6 fields.
	1. version
	2. p
	3. q
	4. dp
	5. dq
	6. qinv

	But now since CRT is present in kernel code, except version we need to additionally
	encode the remaining 5 fields mentioned above.

	Hence we are skipping one field with the blank declared above (1 x 3)
	*/

	total = 3 + nlen;
	if(nlen <= 127)
		total = total + 2;
	else if(nlen >= 128 && nlen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + elen;
	if(elen <= 127)
		total = total + 2;
	else if(elen >= 128 && elen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + dlen;
	if(dlen <= 127)
		total = total + 2;
	else if(dlen >= 128 && dlen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + plen;
	if(plen <= 127)
		total = total + 2;
	else if(plen >= 128 && plen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + qlen;
	if(qlen <= 127)
		total = total + 2;
	else if(qlen >= 128 && qlen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + dplen;
	if(dplen <= 127)
		total = total + 2;
	else if(dplen >= 128 && dplen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + dqlen;
	if(dqlen <= 127)
		total = total + 2;
	else if(dqlen >= 128 && dqlen <= 255)
		total = total + 3;
	else
		total = total + 4;

	total = total + qinvlen;
	if(qinvlen <= 127)
		total = total + 2;
	else if(qinvlen >= 128 && qinvlen <= 255)
		total = total + 3;
	else
		total = total + 4;

	if(total <= 127)
		extra = 2;
	else if(total >= 128 && total <= 255)
		extra = 3;
	else
		extra = 4;

/*Calculated total length and extra bytes*/
/*Start Prepare buffer*/		
	int ret = alloc_buf(total + extra + 1, pk);
	if(ret)
		return ret;
	ptr = pk->buf;
	ptr[0] = 0x30;
	if(extra == 2)
		memcpy(ptr + 1, &total, 1);
	if(extra == 3)
	{
		ptr[1] = 0x81;
		memcpy(ptr + 2, &total, 1);
	}
	if(extra == 4)
	{
		tmp = (unsigned char*)(&total);
		ptr[1] = 0x82;
		memcpy(ptr + 2, tmp + 1, 1);
		memcpy(ptr + 3, tmp , 1);
	}

	ptr = ptr + extra;
	/*Write blank version*/
	memcpy(ptr, blank, 3);	
	ptr = ptr + 3;
	/*Write n field*/
	ptr = write_field(ptr, data->n.buf, nlen);
	ptr = write_field(ptr, data->e.buf, elen);
	ptr = write_field(ptr, d->buf, dlen);
	ptr = write_field(ptr, p->buf, plen);
	ptr = write_field(ptr, q->buf, qlen);
	ptr = write_field(ptr, dp->buf, dplen);
	ptr = write_field(ptr, dq->buf, dqlen);
	ptr = write_field(ptr, qinv->buf, qinvlen);

	return 0;
}
